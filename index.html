<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Print Quote & Invoice</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#0f172a;         /* slate-900 */
    --muted:#475569;       /* slate-600 */
    --line:#e2e8f0;        /* slate-200 */
    --brand:#2563eb;       /* blue-600 */
  }
  *{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .card{ border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); padding:20px }
  .label{ font-size:.85rem; font-weight:600; color:#334155 }
  .ipt{ margin-top:.25rem; width:100%; border:1px solid #CBD5E1; border-radius:12px; padding:.6rem .8rem; outline:0 }
  .ipt:focus{ box-shadow:0 0 0 3px rgba(37,99,235,.25); border-color:#93C5FD }
  .kpi{ font-weight:700; font-size:1.25rem }
  .btn{ border-radius:12px; padding:.6rem .9rem; }
  .btn-outline{ border:1px solid #CBD5E1 }
  .btn-primary{ background:var(--brand); color:#fff }
  .badge{ font-size:.7rem; padding:.2rem .5rem; border-radius:999px; background:#EFF6FF; color:#1D4ED8 }
  .num{ font-variant-numeric: tabular-nums }

  /* ---------- INVOICE LAYOUT (screen + print) ---------- */
  #invoice{
    color:var(--ink);
    background:#fff;
    width:8.5in;                   /* Letter width */
    max-width:100%;
    margin-inline:auto;
    border:1px solid var(--line);
    border-radius:16px;
    padding:28px;
  }
  @media (min-width: 1100px){ #invoice{ position:sticky; top:88px } }

  #inv-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px }
  #inv-biz{ display:flex; align-items:center; gap:12px }
  #logoImg{ width:60px; height:60px; object-fit:contain; display:none }
  #logoImg.show{ display:block }
  #inv-title{ text-align:right }
  #inv-title .big{ font-weight:800; letter-spacing:.06em; font-size:1.6rem }

  table.inv{
    width:100%; border-collapse:separate; border-spacing:0;
    border:1px solid var(--line); border-radius:12px; overflow:hidden
  }
  table.inv thead th{
    background:#F8FAFC; color:#334155; font-size:.75rem; letter-spacing:.03em;
    text-transform:uppercase; padding:10px 12px; text-align:left; border-bottom:1px solid var(--line)
  }
  table.inv td{ padding:12px; border-bottom:1px solid var(--line) }
  table.inv tr:last-child td{ border-bottom:none }
  table.inv .right{ text-align:right }
  table.inv .desc{ width:65% }

  .totals{
    width:min(380px,100%); margin-left:auto; border:1px solid var(--line); border-radius:12px; overflow:hidden
  }
  .totals .row{ display:flex; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line) }
  .totals .row:last-child{ border-bottom:none }
  .totals .grand{ font-size:1.125rem; font-weight:700 }

  .meta{ display:grid; grid-template-columns:1fr 1fr; gap:14px; color:var(--muted); font-size:.9rem }
  .muted{ color:var(--muted) }

  /* print: only invoice, perfect margins, hide top bar/buttons */
  @media print{
    body{ margin:0; background:#fff }
    .noprint{ display:none !important }   /* <— hide Save/Load/Clear/Print buttons bar */
    #app{ display:none }                   /* hide the editor */
    #invoice{ border:none; border-radius:0; width:7.5in; padding:.5in; page-break-inside:avoid }
  }
</style>
</head>
<body class="bg-gray-50">

<!-- Top bar -->
<header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b noprint">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="badge">3D Printing</span>
      <div class="font-semibold">Quote & Invoice</div>
    </div>
    <div class="flex gap-2">
      <button id="saveBtn" class="btn btn-outline">Save</button>
      <button id="loadBtn" class="btn btn-outline">Load</button>
      <button id="clearBtn" class="btn btn-outline">Clear</button>
      <button id="printInvoiceBtn" class="btn btn-outline">Print Invoice</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-2 gap-6">
  <!-- LEFT: Editor -->
  <section id="app" class="space-y-5">
    <!-- Job -->
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">Job details</h2>
        <span class="badge">Step 1</span>
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div><label class="label">Part / Job name</label><input id="partName" class="ipt" placeholder="e.g., Gearbox cover"></div>
        <div><label class="label">Internal notes</label><input id="jobNotes" class="ipt" placeholder="layer height, infill, color…"></div>
      </div>
      <div class="grid sm:grid-cols-4 gap-4 mt-4">
        <div class="sm:col-span-2">
          <label class="label">Printer</label>
          <select id="printerSelect" class="ipt"></select>
        </div>
        <div><label class="label">Wattage (W)</label><input id="wattage" type="number" step="1" class="ipt"></div>
        <div><label class="label">Print time (hrs)</label><input id="printHrs" type="number" step="0.01" class="ipt"></div>
        <div><label class="label">Printer price ($)</label><input id="printerPrice" type="number" step="0.01" class="ipt"></div>
        <div><label class="label">Lifetime hours</label><input id="lifetimeHrs" type="number" step="1" class="ipt"></div>
      </div>
    </div>

    <!-- Material -->
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">Material</h2>
        <span class="badge">Step 2</span>
      </div>
      <div class="grid sm:grid-cols-6 gap-4">
        <div class="sm:col-span-3"><label class="label">Filament</label><select id="filamentSelect" class="ipt"></select></div>
        <div><label class="label">Diameter (mm)</label><input id="diameter" type="number" step="0.01" class="ipt"></div>
        <div><label class="label">Density (g/cm³)</label><input id="density" type="number" step="0.01" class="ipt"></div>
        <div><label class="label">Spool price ($)</label><input id="spoolPrice" type="number" step="0.01" class="ipt"></div>
        <div><label class="label">Spool weight (g)</label><input id="spoolWeight" type="number" step="1" class="ipt"></div>
        <div><label class="label">Empty spool (g)</label><input id="emptySpool" type="number" step="1" class="ipt"></div>
        <div class="sm:col-span-3">
          <label class="label">Usage (enter one)</label>
          <div class="grid grid-cols-2 gap-3">
            <input id="gramsUsed" type="number" step="0.01" class="ipt" placeholder="Grams used">
            <input id="lengthM"  type="number" step="0.01" class="ipt" placeholder="Length (m)">
          </div>
        </div>
      </div>
      <div class="grid sm:grid-cols-3 gap-4 mt-4">
        <div class="bg-gray-50 rounded-xl p-3"><div class="text-xs text-gray-500">Cost / g</div><div id="costPerGram" class="kpi num">$0.00</div></div>
        <div class="bg-gray-50 rounded-xl p-3"><div class="text-xs text-gray-500">g / meter</div><div id="gPerM" class="kpi num">0.000</div></div>
        <div class="bg-gray-50 rounded-xl p-3"><div class="text-xs text-gray-500">Final grams</div><div id="finalGrams" class="kpi num">0.00</div></div>
      </div>
    </div>

    <!-- Rates -->
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">Rates & adjustments</h2>
        <span class="badge">Step 3</span>
      </div>
      <div class="grid sm:grid-cols-6 gap-4">
        <div><label class="label">Labor (hrs)</label><input id="laborHrs" type="number" step="0.01" class="ipt" value="0.5"></div>
        <div><label class="label">Labor $/hr</label><input id="laborRate" type="number" step="0.01" class="ipt" value="20"></div>
        <div><label class="label">Electricity $/kWh</label><input id="kwhRate" type="number" step="0.0001" class="ipt" value="0.1354"></div>
        <div><label class="label">Overhead %</label><input id="overheadPct" type="number" step="0.1" class="ipt" value="10"></div>
        <div><label class="label">Margin % (suggested)</label><input id="marginPct" type="number" step="0.1" class="ipt" value="30"></div>
        <div><label class="label">Packaging $</label><input id="packagingCost" type="number" step="0.01" class="ipt" value="0"></div>
        <div><label class="label">Shipping $</label><input id="shipping" type="number" step="0.01" class="ipt" value="0"></div>
        <div><label class="label">Discount $</label><input id="discount" type="number" step="0.01" class="ipt" value="0"></div>
        <div><label class="label">Tax %</label><input id="taxPct" type="number" step="0.1" class="ipt" value="0"></div>
      </div>
    </div>

    <!-- Business / Customer -->
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">Business, customer & options</h2>
        <span class="badge">Step 4</span>
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="label">Upload logo (PNG/JPG)</label>
          <input id="logoInput" type="file" accept="image/*" class="ipt">
          <button id="clearLogo" class="btn btn-outline mt-2">Remove logo</button>
        </div>
        <div class="grid grid-cols-2 gap-3 items-center">
          <label class="label m-0 flex items-center gap-2"><input id="showNotes" type="checkbox" checked>Show notes</label>
          <label class="label m-0 flex items-center gap-2"><input id="showTerms" type="checkbox" checked>Show terms</label>
        </div>
      </div>
      <div class="grid sm:grid-cols-2 gap-4 mt-2">
        <div><label class="label">Your business / logo text</label><input id="bizName" class="ipt" value="Huron 3D Studio"></div>
        <div><label class="label">Your contact</label><input id="bizContact" class="ipt" value="Huron, SD · (555) 123-4567 · you@example.com"></div>
        <div><label class="label">Customer name</label><input id="custName" class="ipt"></div>
        <div><label class="label">Customer contact</label><input id="custContact" class="ipt"></div>
        <div><label class="label">Invoice #</label><input id="invNo" class="ipt" placeholder="Auto"></div>
        <div><label class="label">PO / Ref</label><input id="po" class="ipt"></div>
        <div><label class="label">Public notes</label><input id="publicNotes" class="ipt" placeholder="Care, color, tolerances, lead time…"></div>
        <div><label class="label">Terms</label><input id="terms" class="ipt" value="Net 7 · Non-refundable after print"></div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Polished Invoice -->
  <aside id="invoice" class="bg-white">
    <div id="inv-header">
      <div id="inv-biz">
        <img id="logoImg" alt="logo">
        <div>
          <div id="pBizName" class="text-xl font-bold">Huron 3D Studio</div>
          <div id="pBizContact" class="text-sm muted">—</div>
        </div>
      </div>
      <div id="inv-title">
        <div class="big tracking-widest">INVOICE</div>
        <div class="muted text-sm">#<span id="pInvNo">—</span> · <span id="pDate"></span></div>
      </div>
    </div>

    <div class="meta mt-4">
      <div>
        <div class="muted text-xs">Bill to</div>
        <div id="pCustName" class="font-semibold">—</div>
        <div id="pCustContact" class="text-sm muted">—</div>
      </div>
      <div class="text-right">
        <div class="muted text-xs">PO / Ref</div>
        <div id="pPO">—</div>
      </div>
    </div>

    <div class="mt-5">
      <table class="inv">
        <thead>
          <tr>
            <th class="desc">Description</th>
            <th class="right">Qty</th>
            <th class="right">Rate</th>
            <th class="right">Amount</th>
          </tr>
        </thead>
        <tbody id="lines"></tbody>
      </table>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="space-y-1 text-sm">
        <div class="muted">Breakdown</div>
        <div>Filament: <span id="pFilament" class="num">$0.00</span></div>
        <div>Energy: <span id="pEnergy" class="num">$0.00</span></div>
        <div>Depreciation: <span id="pDepr" class="num">$0.00</span></div>
        <div>Labor: <span id="pLabor" class="num">$0.00</span></div>
        <div>Overhead: <span id="pOverhead" class="num">$0.00</span></div>
        <div>Packaging: <span id="pPack" class="num">$0.00</span></div>
        <div>Shipping: <span id="pShip" class="num">$0.00</span></div>
      </div>
      <div class="totals">
        <div class="row"><span>Subtotal</span><span id="pSub" class="num">$0.00</span></div>
        <div class="row"><span>Discount</span><span id="pDisc" class="num">-$0.00</span></div>
        <div class="row"><span>Tax</span><span id="pTax" class="num">$0.00</span></div>
        <div class="row grand"><span>Total due</span><span id="pTotal" class="num">$0.00</span></div>
      </div>
    </div>

    <div id="notesRow" class="mt-4 text-sm"><span class="font-semibold">Notes:</span> <span id="pPublicNotes">—</span></div>
    <div id="termsRow" class="mt-1 text-sm"><span class="font-semibold">Terms:</span> <span id="pTerms">—</span></div>
  </aside>
</main>

<script>
const $=id=>document.getElementById(id);
const money=n=>new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(isFinite(n)?n:0);
const fixed=(n,d=2)=> (isFinite(n)?n.toFixed(d):"0.00");

/* ----- seed data ----- */
const printers=[{id:"A1-USA",name:"Bambu Lab A1",watt:350,price:399,life:3000},{id:"PRN-002",name:"Generic Prusa",watt:150,price:250,life:2500}];
const filaments=[{id:"PETG-CF",brand:"Bambu Lab",mat:"PETG-CF",dia:1.75,density:1.25,spoolG:1000,emptyG:230,price:31.99},{id:"PLA-AERO",brand:"Bambu Lab",mat:"PLA Aero",dia:1.75,density:1.21,spoolG:1000,emptyG:230,price:44.99},{id:"PLA",brand:"Generic",mat:"PLA",dia:1.75,density:1.24,spoolG:1000,emptyG:230,price:22.5}];

const pSel=$("printerSelect"), fSel=$("filamentSelect");
printers.forEach(p=>{const o=document.createElement("option");o.value=p.id;o.textContent=`${p.name} (${p.id})`;pSel.appendChild(o);});
filaments.forEach(f=>{const o=document.createElement("option");o.value=f.id;o.textContent=`${f.brand} ${f.mat} (${f.id})`;fSel.appendChild(o);});

const F={
  partName:$("partName"), jobNotes:$("jobNotes"),
  wattage:$("wattage"), printHrs:$("printHrs"), printerPrice:$("printerPrice"), lifetimeHrs:$("lifetimeHrs"),
  diameter:$("diameter"), density:$("density"), spoolWeight:$("spoolWeight"), emptySpool:$("emptySpool"), spoolPrice:$("spoolPrice"),
  gramsUsed:$("gramsUsed"), lengthM:$("lengthM"),
  laborHrs:$("laborHrs"), laborRate:$("laborRate"), kwhRate:$("kwhRate"),
  overheadPct:$("overheadPct"), marginPct:$("marginPct"), packagingCost:$("packagingCost"),
  shipping:$("shipping"), discount:$("discount"), taxPct:$("taxPct"),
  bizName:$("bizName"), bizContact:$("bizContact"),
  custName:$("custName"), custContact:$("custContact"),
  invNo:$("invNo"), po:$("po"), publicNotes:$("publicNotes"), terms:$("terms"),
  showNotes:$("showNotes"), showTerms:$("showTerms"),
  logoInput:$("logoInput"), clearLogo:$("clearLogo"), logoImg:$("logoImg")
};

/* ----- helpers ----- */
const gramsPerMeter=(d,dens)=>100*Math.PI*Math.pow(d/20,2)*dens;
const costPerGram=(price,spoolG,emptyG)=>{const net=spoolG-emptyG;return net>0?price/net:0;};

function loadPrinter(id){const p=printers.find(x=>x.id===id);if(!p)return;F.wattage.value=p.watt;F.printerPrice.value=p.price;F.lifetimeHrs.value=p.life;calc();}
function loadFilament(id){const f=filaments.find(x=>x.id===id);if(!f)return;F.diameter.value=f.dia;F.density.value=f.density;F.spoolWeight.value=f.spoolG;F.emptySpool.value=f.emptyG;F.spoolPrice.value=f.price;calc();}

pSel.addEventListener("change",e=>loadPrinter(e.target.value));
fSel.addEventListener("change",e=>loadFilament(e.target.value));
Object.values(F).forEach(el=>{if(el&&el.addEventListener)el.addEventListener("input",calc);});

/* ----- persistence ----- */
$("saveBtn").addEventListener("click",()=>{localStorage.setItem("quote",JSON.stringify(readState()));alert("Saved locally.");});
$("loadBtn").addEventListener("click",()=>{const s=localStorage.getItem("quote");if(!s)return alert("Nothing saved.");writeState(JSON.parse(s));calc();});
$("clearBtn").addEventListener("click",()=>{localStorage.removeItem("quote");localStorage.removeItem("logoData");Object.values(F).forEach(el=>{if(el.value!==undefined)el.value=""});F.showNotes.checked=F.showTerms.checked=true;F.logoImg.classList.remove("show");calc();});

/* ----- print only invoice ----- */
$("printInvoiceBtn").addEventListener("click",()=>window.print());

/* ----- logo upload ----- */
F.logoInput.addEventListener("change",e=>{
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();r.onload=()=>{localStorage.setItem("logoData",r.result);applyLogo(r.result);};r.readAsDataURL(file);
});
F.clearLogo.addEventListener("click",()=>{localStorage.removeItem("logoData");F.logoImg.classList.remove("show");});
function applyLogo(data){if(data){F.logoImg.src=data;F.logoImg.classList.add("show");}}

/* ----- state ----- */
function readState(){const o={};Object.entries(F).forEach(([k,el])=>{if(el&&el.value!==undefined)o[k]=el.value});o.printer=pSel.value;o.filament=fSel.value;o.showNotes=F.showNotes.checked;o.showTerms=F.showTerms.checked;o.logoData=localStorage.getItem("logoData")||"";return o;}
function writeState(o){Object.entries(F).forEach(([k,el])=>{if(el&&el.value!==undefined&&o[k]!==undefined)el.value=o[k]});if(o.printer)pSel.value=o.printer;if(o.filament)fSel.value=o.filament;F.showNotes.checked=!!o.showNotes;F.showTerms.checked=!!o.showTerms;if(o.logoData)applyLogo(o.logoData);}

/* ----- calculator ----- */
function calc(){
  const dia=parseFloat(F.diameter.value)||0, dens=parseFloat(F.density.value)||0;
  const spoolG=parseFloat(F.spoolWeight.value)||0, emptyG=parseFloat(F.emptySpool.value)||0, spoolPrice=parseFloat(F.spoolPrice.value)||0;
  const printHrs=parseFloat(F.printHrs.value)||0, watt=parseFloat(F.wattage.value)||0, life=parseFloat(F.lifetimeHrs.value)||0, price=parseFloat(F.printerPrice.value)||0;
  const laborHrs=parseFloat(F.laborHrs.value)||0, laborRate=parseFloat(F.laborRate.value)||0, kwh=parseFloat(F.kwhRate.value)||0;
  const overhead=(parseFloat(F.overheadPct.value)||0)/100, margin=(parseFloat(F.marginPct.value)||0)/100;
  const pack=parseFloat(F.packagingCost.value)||0, ship=parseFloat(F.shipping.value)||0, disc=parseFloat(F.discount.value)||0, taxPct=(parseFloat(F.taxPct.value)||0)/100;

  const gpm=gramsPerMeter(dia,dens);
  const cpg=costPerGram(spoolPrice,spoolG,emptyG);
  const grams=F.gramsUsed.value!==""?parseFloat(F.gramsUsed.value)||0:(parseFloat(F.lengthM.value)||0)*gpm;

  const filament=grams*cpg;
  const energy=(watt*printHrs/1000)*kwh;
  const depr=life>0?(printHrs/life)*price:0;
  const labor=laborHrs*laborRate;
  const overheadCost=(filament+energy+depr+labor)*overhead;
  const subtotal=filament+energy+depr+labor+overheadCost+pack;
  const beforeTax=Math.max(0,subtotal-disc)+ship;
  const tax=beforeTax*taxPct;
  const total=beforeTax+tax;
  const suggested=subtotal*(1+margin);

  $("costPerGram").textContent=money(cpg);
  $("gPerM").textContent=fixed(gpm,3);
  $("finalGrams").textContent=fixed(grams,2);

  $("pFilament").textContent=money(filament);
  $("pEnergy").textContent=money(energy);
  $("pDepr").textContent=money(depr);
  $("pLabor").textContent=money(labor);
  $("pOverhead").textContent=money(overheadCost);
  $("pPack").textContent=money(pack);
  $("pShip").textContent=money(ship);
  $("pSub").textContent=money(subtotal);
  $("pDisc").textContent="-"+money(disc);
  $("pTax").textContent=money(tax);
  $("pTotal").textContent=money(total);

  $("pBizName").textContent=F.bizName.value||"—";
  $("pBizContact").textContent=F.bizContact.value||"—";
  $("pCustName").textContent=F.custName.value||"—";
  $("pCustContact").textContent=F.custContact.value||"—";
  $("pPO").textContent=F.po.value||"—";
  $("pPublicNotes").textContent=F.publicNotes.value||"—";
  $("pTerms").textContent=F.terms.value||"—";
  $("notesRow").style.display=F.showNotes.checked?"":"none";
  $("termsRow").style.display=F.showTerms.checked?"":"none";
  $("pInvNo").textContent=F.invNo.value||autoInv();
  $("pDate").textContent=new Date().toLocaleDateString();

  const desc=(F.partName.value||"3D print job")+(F.jobNotes.value?` — ${F.jobNotes.value}`:"");
  $("lines").innerHTML=`
    <tr>
      <td class="desc">${escapeHTML(desc)}</td>
      <td class="right num">1</td>
      <td class="right num">${money(suggested)}</td>
      <td class="right num">${money(total)}</td>
    </tr>`;
}

function escapeHTML(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","<":">","\"":"&quot;","'":"&#39;"}[m]));}
function autoInv(){const d=new Date(),pad=n=>String(n).padStart(2,"0");return `INV-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`}

/* init */
(function(){
  const logo=localStorage.getItem("logoData"); if(logo){F.logoImg.src=logo;F.logoImg.classList.add("show")}
  pSel.value=printers[0].id; fSel.value=filaments[0].id;
  loadPrinter(printers[0].id); loadFilament(filaments[0].id);
  calc();
})();
</script>
</body>
</html>
